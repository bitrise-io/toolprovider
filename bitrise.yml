format_version: "17"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

meta:
  bitrise.io:
    stack: ubuntu-noble-24.04-bitrise-2025-android
  experimental:
    tools:
      golang:
        version: "1.22"
        resolution_strategy: closest_installed

workflows:
  release-snapshot:
    triggers:
      push:
        - branch: main
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@8: {}
      - script@1:
          title: Run toolprovider
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                gh release download --repo bitrise-io/toolprovider --pattern toolprovider-linux-arm64 --dir /usr/local/bin
                toolprovider
      - script@1:
          title: Install GoReleaser
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
                sudo apt update
                sudo apt install goreleaser
      - script@1:
          title: Run tests
          inputs:
            - content: go test ./...
      - script@1:
          title: Create GitHub Release
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                git tag -a "v0.0.0-$(git rev-parse --short HEAD)" -m "Snapshot release"
                goreleaser release --clean
